{"version":3,"file":"Lighting.js","sourceRoot":"","sources":["../../src/features/Lighting.ts"],"names":[],"mappings":"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","sourcesContent":["/* @license\n * Copyright 2022 Lowe's Companies, Inc. All Rights Reserved.\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy\n * of this software and associated documentation files (the \"Software\"), to deal\n * in the Software without restriction, including without limitation the rights\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n * copies of the Software, and to permit persons to whom the Software is\n * furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in\n * all copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n * THE SOFTWARE.\n */\nimport {\n\tAbstractMesh,\n\tColor3,\n\tCubeTexture,\n\tEnvironmentHelper,\n\tHemisphericLight,\n\tIEnvironmentHelperOptions,\n\tImageProcessingConfiguration,\n\tVector3,\n} from \"@babylonjs/core\";\nimport { property } from \"lit/decorators.js\";\nimport ProductViewerElementBase from \"../product-viewer-base\";\nimport { Constructor, getBoundingBox } from \"../tools/Utils\";\n\nexport declare interface LightingInterface {\n\tlightIntensity: number;\n\tenvironment: string;\n\tcreateGround: boolean;\n\tcreateSkybox: boolean;\n}\n\nexport const LightingMixin = <T extends Constructor<ProductViewerElementBase>>(\n\tBaseViewerElement: T,\n): Constructor<LightingInterface> & T => {\n\tclass LightingModelViewerElement extends BaseViewerElement {\n\t\themisphericLight: HemisphericLight;\n\t\tenvHelper: EnvironmentHelper;\n\t\t@property({ type: Number, attribute: \"light-intensity\" }) lightIntensity = 2.0;\n\t\t@property({ type: String, attribute: \"environment\" }) environment = \"\";\n\t\t@property({ type: Boolean, attribute: \"create-ground\" }) createGround = false;\n\t\t@property({ type: Boolean, attribute: \"create-skybox\" }) createSkybox = false;\n\n\t\tupdated(changedProperties: Map<string, any>): void {\n\t\t\tsuper.updated?.(changedProperties);\n\t\t\tthis.updateLighting();\n\t\t}\n\n\t\tmodelLoaded(meshes: AbstractMesh[]): void {\n\t\t\tsuper.modelLoaded?.(meshes);\n\n\t\t\t// Get the root node of the first mesh to calculate total bounds for correct floor placement\n\t\t\t// Since all glbs import with under __root__ node, it doesn't matter which mesh index we use\n\t\t\tif (this.envHelper.ground) {\n\t\t\t\tconst boundingBox = getBoundingBox(meshes[0]);\n\t\t\t\tthis.envHelper.ground.position.y -= boundingBox.extendSizeWorld.y - boundingBox.centerWorld.y;\n\t\t\t}\n\t\t}\n\n\t\tupdateLighting(): void {\n\t\t\t// Lights\n\t\t\tif (!this.hemisphericLight)\n\t\t\t\tthis.hemisphericLight = new HemisphericLight(\"HemisphericLight\", new Vector3(0, 1, 0), this.scene);\n\n\t\t\tthis.hemisphericLight.intensity = this.lightIntensity;\n\n\t\t\tconst envOptions: Partial<IEnvironmentHelperOptions> = {\n\t\t\t\tcreateGround: this.createGround,\n\t\t\t\tgroundColor: new Color3(1, 1, 1),\n\t\t\t\tcreateSkybox: this.createSkybox,\n\t\t\t\tskyboxColor: new Color3(1, 1, 1),\n\t\t\t};\n\t\t\tif (this.environment) {\n\t\t\t\tconst hdrTexture = CubeTexture.CreateFromPrefilteredData(this.environment, this.scene);\n\t\t\t\tenvOptions.environmentTexture = hdrTexture;\n\n\t\t\t\t// NOTE: due to a bug in Babylon.js, when a new environmentTexture is passed to\n\t\t\t\t// envHelper.updateOptions(), the old object is disposed, but not set to null.\n\t\t\t\t// https://github.com/BabylonJS/Babylon.js/blob/40f0ba2cc8a7acbd9dbdc81492a305fa781a41bc/src/Helpers/environmentHelper.ts#L406\n\t\t\t\t// This prevents the update from completing due to a check in _setupEnvironmentTexture():\n\t\t\t\t// https://github.com/BabylonJS/Babylon.js/blob/40f0ba2cc8a7acbd9dbdc81492a305fa781a41bc/src/Helpers/environmentHelper.ts#L450\n\t\t\t\tif (this.scene.environmentTexture) {\n\t\t\t\t\tthis.scene.environmentTexture.dispose();\n\t\t\t\t\tthis.scene.environmentTexture = null;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// NOTE: We need to remove the old envHelper before creating a new one when the `model-url` is updated.\n\t\t\t// It seems like we should be able to use `this.envHelper.updateOptions(envOptions)`,\n\t\t\t// however this causes the skybox & ground to disappear (or turn completely white).\n\t\t\tif (this.envHelper) this.envHelper.dispose();\n\n\t\t\tthis.envHelper = this.scene.createDefaultEnvironment(envOptions);\n\n\t\t\t// Enable tonemapping to prevent white blowout\n\t\t\tthis.scene.imageProcessingConfiguration.toneMappingEnabled = true;\n\t\t\tthis.scene.imageProcessingConfiguration.toneMappingType = ImageProcessingConfiguration.TONEMAPPING_ACES;\n\t\t}\n\t}\n\treturn LightingModelViewerElement as Constructor<LightingInterface> & T;\n};\n"]}