{"version":3,"file":"Camera.js","sourceRoot":"","sources":["../../src/features/Camera.ts"],"names":[],"mappings":"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","sourcesContent":["/* @license\n * Copyright 2022 Lowe's Companies, Inc. All Rights Reserved.\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy\n * of this software and associated documentation files (the \"Software\"), to deal\n * in the Software without restriction, including without limitation the rights\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n * copies of the Software, and to permit persons to whom the Software is\n * furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in\n * all copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n * THE SOFTWARE.\n */\nimport { AbstractMesh, ArcRotateCamera, FramingBehavior, Vector2, Vector3 } from \"@babylonjs/core\";\nimport { property } from \"lit/decorators.js\";\nimport ProductViewerElementBase from \"../product-viewer-base\";\nimport { Constructor } from \"../tools/Utils\";\n\nexport declare interface CameraInterface {\n\talpha: number;\n\tbeta: number;\n\tframeDuration: number;\n\tisFraming: boolean;\n}\n\nexport const CameraMixin = <T extends Constructor<ProductViewerElementBase>>(\n\tBaseViewerElement: T,\n): Constructor<CameraInterface> & T => {\n\tclass CameraModelViewerElement extends BaseViewerElement {\n\t\t@property({ type: Number, attribute: \"alpha\" }) alpha = 0;\n\t\t@property({ type: Number, attribute: \"beta\" }) beta = 0;\n\t\t@property({ type: Number, attribute: \"frame-duration\" }) frameDuration = 500;\n\t\tisFraming = false;\n\t\tframingBehavior: FramingBehavior;\n\t\tpivotPoint = Vector3.Zero();\n\n\t\tupdated(changedProperties: Map<string, any>) {\n\t\t\tsuper.updated?.(changedProperties);\n\n\t\t\tif (!this.camera) this.createCamera();\n\t\t}\n\n\t\tcreateCamera(): void {\n\t\t\t// Set initial camera angle (defaults to targeting thie origin, but zooms to mesh once one loads)\n\t\t\tconst camera = new ArcRotateCamera(\"MainCamera\", Math.PI / 4, 1, 5, this.pivotPoint, this.scene);\n\n\t\t\tcamera.zoomToMouseLocation = true;\n\t\t\tcamera.wheelPrecision = 25;\n\t\t\tcamera.pinchPrecision = 100;\n\t\t\tcamera.panningDistanceLimit = 3;\n\t\t\tcamera.angularSensibilityY = 900;\n\t\t\tcamera.minZ = 0.01;\n\t\t\tcamera.maxZ = 15000;\n\t\t\tcamera.checkCollisions = true;\n\t\t\tcamera.useFramingBehavior = true;\n\t\t\tthis.framingBehavior = camera.getBehaviorByName(\"Framing\") as FramingBehavior;\n\t\t\tthis.framingBehavior.framingTime = this.frameDuration;\n\t\t\tthis.framingBehavior.autoCorrectCameraLimitsAndSensibility = true;\n\t\t\tthis.framingBehavior.zoomStopsAnimation = true;\n\t\t\tthis.framingBehavior.elevationReturnTime = -1; // disable returning to elevation\n\t\t\tArcRotateCamera.ForceAttachControlToAlwaysPreventDefault = true;\n\t\t\tcamera.attachControl(this.renderCanvas, true);\n\t\t\tcamera.storeState();\n\n\t\t\tthis.scene.onBeforeRenderObservable.add(() => {\n\t\t\t\tconst w = this.engine.getRenderWidth(),\n\t\t\t\t\th = this.engine.getRenderHeight();\n\t\t\t\tcamera.orthoLeft = (5 * w) / h;\n\t\t\t\tcamera.orthoTop = 5;\n\t\t\t\tcamera.orthoRight = (-5 * w) / h;\n\t\t\t\tcamera.orthoBottom = -5;\n\t\t\t});\n\n\t\t\tthis.enableOrbitAroundModel(camera);\n\n\t\t\tthis.camera = camera;\n\t\t}\n\n\t\tmodelLoaded(meshes: AbstractMesh[]) {\n\t\t\tsuper.modelLoaded(meshes);\n\t\t\tthis.camera.restoreState();\n\t\t\tthis.isFraming = true;\n\t\t\tthis.framingBehavior.zoomOnMeshesHierarchy(meshes, true, () => {\n\t\t\t\tthis.pivotPoint.copyFrom((this.camera as ArcRotateCamera).target);\n\t\t\t\tthis.isFraming = false;\n\t\t\t});\n\t\t}\n\n\t\t// This method ensures that the camera target remains locked to the pivotPoint (center of model),\n\t\t// even after the user moves the camera (by right click & drag, or by zooming into the mouse with wheel).\n\t\t// Heavily based on the example by Dave Solares: https://playground.babylonjs.com/#3B5W22#29\n\t\tenableOrbitAroundModel(camera: ArcRotateCamera) {\n\t\t\tthis.scene.onBeforeRenderObservable.add(() => {\n\t\t\t\tif (this.isFraming) return;\n\n\t\t\t\tconst { alpha, beta } = camera;\n\t\t\t\tconst { x, y, z } = Vector3.TransformCoordinates(this.pivotPoint, camera.getViewMatrix());\n\t\t\t\tcamera.target.copyFrom(this.pivotPoint);\n\t\t\t\tcamera.targetScreenOffset.set(x, y);\n\t\t\t\tcamera.alpha = alpha;\n\t\t\t\tcamera.beta = beta;\n\t\t\t\tcamera.radius = z;\n\t\t\t});\n\n\t\t\t// The current behavior enabled by `camera.zoomToMouseLocation` assumes that\n\t\t\t// targetScreenOffset is set to (0, 0). Here we monkeypatch ArcRotateCameraMouseWheelInput._getPosition\n\t\t\t// with a wrapper to temporarily reset the offset back to the origin.\n\t\t\t// https://github.com/BabylonJS/Babylon.js/blob/master/packages/dev/core/src/Cameras/Inputs/arcRotateCameraMouseWheelInput.ts#L208\n\t\t\tconst mouseWheelInput = camera.inputs.attached.mousewheel as any;\n\t\t\tif (mouseWheelInput) {\n\t\t\t\tconst tmpOffset = Vector2.Zero();\n\t\t\t\tconst _getPositionOriginal = mouseWheelInput._getPosition;\n\t\t\t\tmouseWheelInput._getPosition = () => {\n\t\t\t\t\t// save the current target offset to tmp variable\n\t\t\t\t\ttmpOffset.copyFrom(camera.targetScreenOffset);\n\n\t\t\t\t\t// move the camera target offset to zero & run the original function\n\t\t\t\t\tcamera.targetScreenOffset.set(0, 0);\n\t\t\t\t\tconst position: Vector3 = _getPositionOriginal.call(mouseWheelInput);\n\n\t\t\t\t\t// restore the target offset\n\t\t\t\t\tcamera.targetScreenOffset.copyFrom(tmpOffset);\n\n\t\t\t\t\treturn position;\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t}\n\treturn CameraModelViewerElement as Constructor<CameraInterface> & T;\n};\n"]}